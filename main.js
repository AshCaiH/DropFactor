(()=>{"use strict";function t(t,e,i){return t*(1-i)+e*i}function e(t,e,i){return Math.min(Math.max(t,i),e)}let i=()=>{};function s(t,e){let{x:i,y:s,width:r,height:n}=function(t){let{x:e=0,y:i=0,width:s,height:r,radius:n}=t.world||t;return t.mapwidth&&(s=t.mapwidth,r=t.mapheight),n&&(s=2*n.x,r=2*n.y),t.anchor&&(e-=s*t.anchor.x,i-=r*t.anchor.y),s<0&&(e+=s,s*=-1),r<0&&(i+=r,r*=-1),{x:e,y:i,width:s,height:r}}(e);do{i-=e.sx||0,s-=e.sy||0}while(e=e.parent);let o=t.x-Math.max(i,Math.min(t.x,i+r)),h=t.y-Math.max(s,Math.min(t.y,s+n));return o*o+h*h<t.radius*t.radius}let r,n,o={};function h(t,e){o[t]=o[t]||[],o[t].push(e)}function a(t,...e){(o[t]||[]).map((t=>t(...e)))}let c={get:(t,e)=>"_proxy"==e||i};function l(){return r}function d(){return n}class u{constructor(t=0,e=0,i={}){null!=t.x?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),i._c&&(this.clamp(i._a,i._b,i._d,i._e),this.x=t,this.y=e)}set(t){this.x=t.x,this.y=t.y}add(t){return new u(this.x+t.x,this.y+t.y,this)}subtract(t){return new u(this.x-t.x,this.y-t.y,this)}scale(t){return new u(this.x*t,this.y*t)}normalize(t=this.length()||1){return new u(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}length(){return Math.hypot(this.x,this.y)}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}angle(t){return Math.acos(this.dot(t)/(this.length()*t.length()))}direction(){return Math.atan2(this.y,this.x)}clamp(t,e,i,s){this._c=!0,this._a=t,this._b=e,this._d=i,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?e(this._a,this._d,t):t}set y(t){this._y=this._c?e(this._b,this._e,t):t}}function f(){return new u(...arguments)}class g{constructor(t){return this.init(t)}init(t={}){this.position=f(),this.velocity=f(),this.acceleration=f(),this.ttl=1/0,Object.assign(this,t)}update(t){this.advance(t)}advance(t){let e=this.acceleration;t&&(e=e.scale(t)),this.velocity=this.velocity.add(e);let i=this.velocity;t&&(i=i.scale(t)),this.position=this.position.add(i),this._pc(),this.ttl--}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}_pc(){}}class x extends g{init({width:t=0,height:e=0,context:i=d(),render:s=this.draw,update:r=this.advance,children:n=[],anchor:o={x:0,y:0},opacity:a=1,rotation:c=0,drotation:l=0,ddrotation:u=0,scaleX:f=1,scaleY:g=1,...x}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:o,opacity:a,rotation:c,drotation:l,ddrotation:u,scaleX:f,scaleY:g,...x}),this._di=!0,this._uw(),this.addChild(n),this._rf=s,this._uf=r,h("init",(()=>{this.context??=d()}))}update(t){this._uf(t),this.children.map((e=>e.update&&e.update(t)))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),this.rotation&&t.rotate(this.rotation),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=this.width,i=this.height;this.radius&&(e=i=2*this.radius);let s=-e*this.anchor.x,r=-i*this.anchor.y;(s||r)&&t.translate(s,r),this.context.globalAlpha=this.opacity,this._rf(),(s||r)&&t.translate(-s,-r),this.children.map((t=>t.render&&t.render())),t.restore()}draw(){}_pc(){this._uw(),this.children.map((t=>t._pc()))}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wrot:s=0,_wsx:r=1,_wsy:n=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this.radius&&(this._wrx=this.radius,this._wry=this.radius),this._wo=i*this.opacity,this._wsx=r*this.scaleX,this._wsy=n*this.scaleY,this._wx=this._wx*r,this._wy=this._wy*n,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this.radius&&(this._wrx=this.radius*this._wsx,this._wry=this.radius*this._wsy),this._wrot=s+this.rotation;let{x:o,y:h}=function(t,e){let i=Math.sin(e),s=Math.cos(e);return{x:t.x*s-t.y*i,y:t.x*i+t.y*s}}({x:this._wx,y:this._wy},s);this._wx=o,this._wy=h,this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,radius:this.radius?{x:this._wrx,y:this._wry}:void 0,opacity:this._wo,rotation:this._wrot,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...t){t.flat().map((t=>{this.children.push(t),t.parent=this,t._pc=t._pc||i,t._pc()}))}removeChild(...t){t.flat().map((t=>{(function(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0})(this.children,t)&&(t.parent=null,t._pc())}))}get radius(){return this._r}set radius(t){this._r=t,this._pc()}get opacity(){return this._opa}set opacity(t){this._opa=e(0,1,t),this._pc()}get rotation(){return this._rot}set rotation(t){this._rot=t,this._pc()}advance(t){super.advance(t),this.drotation+=this.ddrotation,this.rotation+=this.drotation}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}function y(){return new x(...arguments)}class p extends x{init({image:t,width:e=(t?t.width:void 0),height:i=(t?t.height:void 0),...s}={}){super.init({image:t,width:e,height:i,...s})}get animations(){return this._a}set animations(t){let e,i;for(e in this._a={},t)this._a[e]=t[e].clone(),i=i||this._a[e];this.currentAnimation=i,this.width=this.width||i.width,this.height=this.height||i.height}playAnimation(t){this.currentAnimation?.stop(),this.currentAnimation=this.animations[t],this.currentAnimation.start()}advance(t){super.advance(t),this.currentAnimation?.update(t)}draw(){if(this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height),this.currentAnimation&&this.currentAnimation.render({x:0,y:0,width:this.width,height:this.height,context:this.context}),this.color){if(this.context.fillStyle=this.color,this.radius)return this.context.beginPath(),this.context.arc(this.radius,this.radius,this.radius,0,2*Math.PI),void this.context.fill();this.context.fillRect(0,0,this.width,this.height)}}}function m(){return new p(...arguments)}let w=/(\d+)(\w+)/;class _ extends x{init({text:t="",textAlign:e="",lineHeight:i=1,font:s=d()?.font,...r}={}){t=""+t,super.init({text:t,textAlign:e,lineHeight:i,font:s,...r}),this.context&&this._p(),h("init",(()=>{this.font??=d().font,this._p()}))}get width(){return this._w}set width(t){this._d=!0,this._w=t,this._fw=t}get text(){return this._t}set text(t){this._d=!0,this._t=""+t}get font(){return this._f}set font(t){this._d=!0,this._f=t,this._fs=function(t){if(!t)return{computed:0};let e=t.match(w),i=+e[1];return{size:i,unit:e[2],computed:i}}(t).computed}get lineHeight(){return this._lh}set lineHeight(t){this._d=!0,this._lh=t}render(){this._d&&this._p(),super.render()}_p(){this._s=[],this._d=!1;let t=this.context,e=[this.text];if(t.font=this.font,e=this.text.split("\n"),this._fw&&e.map((e=>{let i=e.split(" "),s=i.shift(),r=s;i.map((e=>{r+=" "+e,t.measureText(r).width>this._fw&&(this._s.push(s),r=e),s=r})),this._s.push(r)})),!this._s.length&&this.text.includes("\n")){let i=0;e.map((e=>{this._s.push(e),i=Math.max(i,t.measureText(e).width)})),this._w=this._fw||i}this._s.length||(this._s.push(this.text),this._w=this._fw||t.measureText(this.text).width),this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight,this._uw()}draw(){let t=0,e=this.textAlign,i=this.context;e=this.textAlign||("rtl"==i.canvas.dir?"right":"left"),t="right"==e?this.width:"center"==e?this.width/2|0:0,this._s.map(((s,r)=>{i.textBaseline="top",i.textAlign=e,i.fillStyle=this.color,i.font=this.font,this.strokeColor&&(i.strokeStyle=this.strokeColor,i.lineWidth=this.lineWidth??1,i.strokeText(s,t,this._fs*this.lineHeight*r)),i.fillText(s,t,this._fs*this.lineHeight*r)}))}}function v(){return new _(...arguments)}let P=new WeakMap,R={},E={},b={0:"left",1:"middle",2:"right"};function S(t=l()){return P.get(t)}function A(t,e){return parseFloat(t.getPropertyValue(e))||0}function I(t){let e=null!=t.button?b[t.button]:"left";E[e]=!0,T(t,"onDown")}function D(t){let e=null!=t.button?b[t.button]:"left";E[e]=!1,T(t,"onUp")}function M(t){T(t,"onOver")}function C(t){P.get(t.target)._oo=null,E={}}function O(t,e,i){let r=function(t){let e=t._lf.length?t._lf:t._cf;for(let i=e.length-1;i>=0;i--){let r=e[i];if(r.collidesWithPointer?r.collidesWithPointer(t):s(t,r))return r}}(t);r&&r[e]&&r[e](i),R[e]&&R[e](i,r),"onOver"==e&&(r!=t._oo&&t._oo&&t._oo.onOut&&t._oo.onOut(i),t._oo=r)}function T(t,e){t.preventDefault();let i=t.target,s=P.get(i),{scaleX:r,scaleY:n,offsetX:o,offsetY:h}=function(t){let{canvas:e,_s:i}=t,s=e.getBoundingClientRect(),r="none"!=i.transform?i.transform.replace("matrix(","").split(","):[1,1,1,1],n=parseFloat(r[0]),o=parseFloat(r[3]),h=(A(i,"border-left-width")+A(i,"border-right-width"))*n,a=(A(i,"border-top-width")+A(i,"border-bottom-width"))*o,c=(A(i,"padding-left")+A(i,"padding-right"))*n,l=(A(i,"padding-top")+A(i,"padding-bottom"))*o;return{scaleX:(s.width-h-c)/e.width,scaleY:(s.height-a-l)/e.height,offsetX:s.left+(A(i,"border-left-width")+A(i,"padding-left"))*n,offsetY:s.top+(A(i,"border-top-width")+A(i,"padding-top"))*o}}(s);t.type.includes("touch")?(Array.from(t.touches).map((({clientX:t,clientY:e,identifier:i})=>{let a=s.touches[i];a||(a=s.touches[i]={start:{x:(t-o)/r,y:(e-h)/n}},s.touches.length++),a.changed=!1})),Array.from(t.changedTouches).map((({clientX:i,clientY:c,identifier:l})=>{let d=s.touches[l];d.changed=!0,d.x=s.x=(i-o)/r,d.y=s.y=(c-h)/n,O(s,e,t),a("touchChanged",t,s.touches),"onUp"==e&&(delete s.touches[l],s.touches.length--,s.touches.length||a("touchEnd"))}))):(s.x=(t.clientX-o)/r,s.y=(t.clientY-h)/n,O(s,e,t))}function k(...t){t.flat().map((t=>{let e=t.context?t.context.canvas:l(),i=P.get(e);if(!i)throw new ReferenceError("Pointer events not initialized for the objects canvas");t.__r||(t.__r=t.render,t.render=function(){i._cf.push(this),this.__r()},i._o.push(t))}))}function L(t,e){let i=t[0].toUpperCase()+t.substr(1);R["on"+i]=e}function N(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}let B,G={},z={},V={},j={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"arrowleft",ArrowUp:"arrowup",ArrowRight:"arrowright",ArrowDown:"arrowdown"};function W(t=i,e){t._pd&&e.preventDefault(),t(e)}function U(t){let e=j[t.code],i=G[e];V[e]=!0,W(i,t)}function X(t){let e=j[t.code],i=z[e];V[e]=!1,W(i,t)}function Y(){V={}}function F(t,e,{handler:i="keydown",preventDefault:s=!0}={}){let r="keydown"==i?G:z;e._pd=s,[].concat(t).map((t=>r[t]=e))}class ${constructor({create:t,maxSize:e=1024}={}){let i;if(!t||!(i=t())||!(i.update&&i.init&&i.isAlive&&i.render))throw Error("Must provide create() function which returns an object with init(), update(), render(), and isAlive() functions");this._c=t,this.objects=[t()],this.size=0,this.maxSize=e}get(t={}){if(this.size==this.objects.length){if(this.size==this.maxSize)return;for(let t=0;t<this.size&&this.objects.length<this.maxSize;t++)this.objects.push(this._c())}let e=this.objects[this.size];return this.size++,e.init(t),e}getAliveObjects(){return this.objects.slice(0,this.size)}clear(){this.size=this.objects.length=0,this.objects.push(this._c())}update(t){let e,i=!1;for(let s=this.size;s--;)e=this.objects[s],e.update(t),e.isAlive()||(i=!0,this.size--);i&&this.objects.sort(((t,e)=>e.isAlive()-t.isAlive()))}render(){for(let t=this.size;t--;)this.objects[t].render()}}function H(){B??=Date.now(),B|=0,B=B+2654435769|0;let t=B^B>>>16;return t=Math.imul(t,569420461),t^=t>>>15,t=Math.imul(t,1935289751),((t^=t>>>15)>>>0)/4294967296}function K(t,e,i=H){return(i()*(e-t+1)|0)+t}class q{constructor(t,e){Object.assign(this,{state:t,transitions:e})}run(t,...e){this.transitions[this.state];const i=this.transitions[this.state][t];if(i)return i.apply(this,...e)}setState(t){this.state=t}setStateAndRun(t,e="start",...i){this.state=t,this.run(e,...i)}}class Z{myvalue;events=[];oneShotEvents=[];get value(){return this.myvalue}set value(t){if("object"==typeof this.myvalue){let e=!0;if(Object.keys(this.myvalue).forEach((i=>{t[i]!=this.myvalue[i]&&(this.myvalue[i]=t[i],e=!1)})),e)return}else if(this.myvalue==t)return;this.myvalue=t,[...this.events,...this.oneShotEvents].forEach((t=>t())),this.oneShotEvents=[]}valueOf(){return this.myvalue}toString(){return"object"==typeof this.myvalue?String(Object.values(this.myvalue)):String(this.myvalue)}constructor(t){this.myvalue=t}listen(t,e=!0,i=!1){i?this.oneShotEvents.push(t):this.events.push(t),e&&t()}clearListeners(){this.events=[]}hasEvents(){return this.events.length>0}}const J={slots:{x:7,y:7},coinRadius:30,coinBuffer:12,coinPalette:["#ffa600","#ff764a","#ef5675","#bc5090","#7a5195","#5779CC","#0073A8"],fallSpeed:12,fallAccel:1.1,turnsInRound:5,initialTurns:0,roundMode:"rise",comboStyle:1,weightCoins:!0,dirtCoins:!1,freePowers:!1};let Q=[],tt={};class et extends p{constructor(t,...e){let i=null,s=new q("DROPZONE",{IDLE:{drop:()=>s.setStateAndRun("DROPPING","start"),pop:()=>s.setStateAndRun("POPPING","start"),crumble:()=>{0!=this.dirtLayer&&this.machine.setStateAndRun("CRUMBLING","start")},snipe:()=>{this.doomed=!0},changeValue:(t=!0)=>s.setStateAndRun("CHANGEVALUE","start",[t]),restart:()=>s.setStateAndRun("RESTARTING")},DROPZONE:{start:t=>{i=t,this.gridPos.x=i.xPos*(2*J.coinRadius+J.coinBuffer),this.x=this.gridPos.x*(2*J.coinRadius+J.coinBuffer)},update:()=>{this.gridPos.x=Math.min(Math.max(0,i.xPos),J.slots.x-1),this.x=this.gridPos.x*(2*J.coinRadius+J.coinBuffer)},drop:()=>{this.x=this.gridPos.x*(2*J.coinRadius+J.coinBuffer),s.setStateAndRun("DROPPING","start")}},DROPPING:{start:()=>{this.x=this.gridPos.x*(2*J.coinRadius+J.coinBuffer),this.dy=J.fallSpeed,tt.grid[this.gridPos.x][this.gridPos.y]=null;for(let t=this.gridPos.y;t<J.slots.y&&null===tt.grid[this.gridPos.x][t];t++)this.gridPos.y=t;return tt.grid[this.gridPos.x][this.gridPos.y]=this,-1==this.gridPos.y?tt.gameOver=!0:s.setState("DROPPING"),!0},update:()=>{this.advance(),this.dy*=J.fallAccel;let t=this.gridPos.y*(2*J.coinRadius+J.coinBuffer);this.y>t&&(this.y=t,s.setState("IDLE"))}},POPPING:{start:()=>{if(this.dirtLayer>0&&!this.doomed)s.setState("IDLE");else{let t=this.machine.run("checkVertical"),e=this.machine.run("checkHorizontal");if(t.length>0||e.length>0||this.doomed)return tt.bg.lightup(t.concat(e)),tt.score.value+=1*tt.combo,tt.roundScore.value+=1*tt.combo,tt.particles.addEffect("popping",{pos:{x:this.x+J.coinRadius,y:this.y+J.coinRadius},color:J.coinPalette[this.value-1]}),this.doomed||this.machine.run("breakSurrounding"),!0;s.setState("IDLE")}},checkVertical:()=>{let t=[];for(let e=J.slots.y-1;e>=0&&null!=tt.grid[this.gridPos.x][e];e--)t.push(`${this.gridPos.x},${e}`);return t.length===this.value?t:[]},checkHorizontal:()=>{let t=this.gridPos.x-1,e=[`${this.gridPos.x},${this.gridPos.y}`];for(;t>=0&&null!=tt.grid[t][this.gridPos.y];)e.push(`${t},${this.gridPos.y}`),t--;for(t=this.gridPos.x+1;t<J.slots.x&&null!=tt.grid[t][this.gridPos.y];)e.push(`${t},${this.gridPos.y}`),t++;return e.length===this.value?e:[]},breakSurrounding:()=>{[[1,0],[-1,0],[0,1],[0,-1]].forEach((t=>{let e=this.gridPos.x+t[0],i=this.gridPos.y+t[1];if(e<0||e>=J.slots.x)return;if(i<0||i>=J.slots.y)return;let s=tt.grid[e][i];s&&s.machine.run("crumble")}))},update:()=>{this.fadeout-=.1,this.fadeout<=0&&(s.setState("IDLE"),this.kill())}},CRUMBLING:{start:()=>{tt.particles.addEffect("crumbling",{pos:{x:this.x+J.coinRadius,y:this.y+J.coinRadius}}),this.dirtLayer--,setTimeout((()=>s.setState("IDLE")),300)}},CHANGEVALUE:{start:(t=!0)=>{var e=()=>{console.log("adding dirt"),this.dirtLayer=Math.min(this.dirtLayer+1,2),tt.particles.addEffect("crumbling",{pos:{x:this.x+J.coinRadius,y:this.y+J.coinRadius}})};if(this.dirtLayer>0)return e(),s.setState("IDLE");t?this.value++:this.value--,(this.value<=0||this.value>tt.maxCoinValue)&&(this.value=K(1,tt.maxCoinValue),e()),s.setState("IDLE")}},RISING:{start:()=>{this.gridPos.y-=1,tt.grid[this.gridPos.x][this.gridPos.y]=this,this.gridPos.y<=-1&&(tt.gameOver=!0)},update:()=>{this.y-=4;let t=this.gridPos.y*(2*J.coinRadius+J.coinBuffer);this.y<=t&&(this.machine.setState("IDLE"),this.y=t)}},RESTARTING:{start:()=>{tt.particles.addEffect("restarting",{pos:{x:this.x+J.coinRadius,y:this.y+J.coinRadius},color:J.coinPalette[this.value-1]}),this.kill()}},POWERPENDING:{},POWERSELECTED:{},OOB:{}});super(Object.assign({},{gridPos:{x:t,y:-1},x:t*(2*J.coinRadius+J.coinBuffer),y:-1*(2*J.coinRadius+J.coinBuffer),value:K(1,tt.maxCoinValue),machine:s,dirtLayer:0,opacity:1,fadeout:1,doomed:!1,zIndex:10,update:()=>s.run("update")},...e)),this.generateCracks()}generateCracks(){let t=K(3,5),e=Math.random();this.cracks=[];for(let i=0;i<t;i++){let s=360*(i/t+.3*Math.random()-.15+e)*Math.PI/180,r=[{x:Math.sin(s)*(J.coinRadius-3),y:Math.cos(s)*(J.coinRadius-3)}];r.push({x:Math.sin(s)*J.coinRadius*(.7+.05*Math.random()),y:Math.cos(s)*J.coinRadius*(.7+.05*Math.random())}),r.push({x:Math.sin(s)*J.coinRadius*(.5+.05*Math.random())+8*Math.random()-4,y:Math.cos(s)*J.coinRadius*(.5+.05*Math.random())+8*Math.random()-4}),r.push({x:Math.sin(s)*J.coinRadius*(.3+.2*Math.random()),y:Math.cos(s)*J.coinRadius*(.3+.2*Math.random())}),this.cracks.push(r)}}kill(){tt.grid[this.gridPos.x][this.gridPos.y]=null,this.ttl=0,this.fadeout=0,this.children=[]}}class it extends p{render(){let t=this.context,e={top:-200,bottom:tt.boardDims.height-J.coinBuffer/2,left:-J.coinBuffer/2,right:tt.boardDims.width-J.coinBuffer/2};t.save(),t.moveTo(e.left,e.top),t.lineTo(e.right,e.top),t.lineTo(e.right,e.bottom),t.lineTo(e.left,e.bottom),t.clip(),[...tt.coins,tt.dropZone.coin].forEach((e=>{if(!e||e.fadeout<1)return;let i=e.dirtLayer>0?e.dirtLayer>1?"#678":"#ABC":J.coinPalette[e.value-1];t.globalOpacity=e.opacity,t.fillStyle=i,t.lineWidth=2.5,t.strokeStyle=i,t.beginPath(),t.arc(J.coinRadius+e.x,J.coinRadius+e.y,J.coinRadius-3,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(J.coinRadius+e.x,J.coinRadius+e.y,J.coinRadius,0,2*Math.PI),t.stroke(),t.fillStyle=e.value>=5?"#CDE":"#311",t.font="bold 26px Arial";const s=0==e.dirtLayer?e.value:"",r=t.measureText(s);t.fillText(0==e.dirtLayer?e.value:"",e.x+J.coinRadius-r.width/2,e.y+J.coinRadius+9),1==e.dirtLayer&&(t.strokeStyle="#222",t.lineWidth=.5,t.beginPath(),e.cracks.forEach((i=>{t.moveTo(e.x+i[0].x+J.coinRadius,e.y+i[0].y+J.coinRadius),t.lineTo(e.x+i[1].x+J.coinRadius,e.y+i[1].y+J.coinRadius),t.lineTo(e.x+i[2].x+J.coinRadius,e.y+i[2].y+J.coinRadius),t.stroke(),t.beginPath(),t.lineTo(e.x+i[3].x+J.coinRadius,e.y+i[3].y+J.coinRadius)})),t.stroke())})),t.restore()}}class st extends p{constructor(){let t=()=>e.setStateAndRun("LOCKED"),e=new q("ACTIVE",{ACTIVE:{start:()=>{tt.isInGrid(tt.cursorCellPos.value,!0)?(this.opacity=.6,this.xPos=tt.cursorCellPos.value.x):e.run("inactive")},prime:()=>e.setStateAndRun("PRIMED_ACTIVE"),lock:()=>t(),inactive:()=>e.setStateAndRun("INACTIVE")},INACTIVE:{start:()=>this.opacity=0,lock:()=>t(e.setStateAndRun("LOCKED")),active:()=>e.setStateAndRun("ACTIVE")},PRIMED_ACTIVE:{start:()=>this.opacity=1,drop:()=>(tt.coins.push(this.coin),this.coin=null,t(),!0),inactive:()=>e.setStateAndRun("PRIMED_INACTIVE")},PRIMED_INACTIVE:{start:()=>this.opacity=.3,drop:()=>e.setStateAndRun("ACTIVE"),active:()=>e.setStateAndRun("PRIMED_ACTIVE")},LOCKED:{start:()=>this.opacity=0,unlock:()=>e.setStateAndRun("ACTIVE")}});super({xPos:4,opacity:1,machine:e,coin:null,zIndex:-1,render:()=>{let t={x:-J.coinBuffer/2+this.xPos*(2*J.coinRadius+J.coinBuffer),y:-J.coinBuffer/2,w:2*J.coinRadius+J.coinBuffer,h:tt.boardDims.height};this.context.fillStyle="#334353AA",this.context.beginPath(),this.context.fillRect(t.x,t.y,t.w,t.h),this.context.closePath()}}),tt.dropZone=this,tt.cursorCellPos.listen((()=>{tt.isInGrid(tt.cursorCellPos.value,!0)?(this.machine.run("active"),"LOCKED"!=this.machine.state&&(this.xPos=tt.cursorCellPos.value.x)):this.machine.run("inactive")})),tt.addDebugText(e,"state","DropZoneState",2)}}const{slots:rt,coinRadius:nt,coinBuffer:ot}=J;class ht extends p{constructor(){super({cells:{},lightup:t=>{t.forEach((t=>this.cells[t].colour[3]=.3))}});for(let t=0;t<rt.x;t++)for(let e=0;e<rt.y;e++){let i=new at({x:t,y:e});this.cells[`${t},${e}`]=i,this.addChild(i)}}}class at extends y{constructor(t){super({gridPosition:t,fillOpacity:0,colour:[255,255,255,0],render:()=>{const e=this.context,i={x:t.x*(2*nt+ot)-ot/2,y:t.y*(2*nt+ot)-ot/2,w:2*nt+ot,h:2*nt+ot};e.lineWidth=1.5,"GAMEOVER"==tt.gameMachine.state?e.strokeStyle="#9559":e.strokeStyle="#345";let s=this.colour;e.fillStyle=`rgba(${s[0]}, ${s[1]}, ${s[2]}, ${s[3]})`,e.fillRect(i.x,i.y,i.w,i.h),e.strokeRect(i.x,i.y,i.w,i.h)},update:()=>{this.colour[3]>0&&(this.colour[3]-=.01)}})}}function ct(){tt.debugInfo.opacity=1-tt.debugInfo.opacity}L("down",(t=>tt.gameMachine.run("prime"))),L("up",(t=>tt.gameMachine.run("drop"))),F("r",(t=>tt.gameMachine.run("restart"))),F("d",(t=>ct())),document.getElementById("debugbtn").onclick=()=>ct();const lt=Object.freeze({board:t=>tt.coins,row:t=>{let e=[];for(let i=0;i<J.slots.x;i++){let s=tt.grid[i][t.y];s&&e.push(s)}return e},column:t=>{let e=[];for(let i=0;i<J.slots.y;i++){let s=tt.grid[t.x][i];s&&e.push(s)}return e},cross:t=>{let e=[];for(let i=0;i<J.slots.x;i++){let s=tt.grid[i][t.y];s&&e.push(s)}for(let i=0;i<J.slots.y;i++){let s=tt.grid[t.x][i];s&&e.push(s)}return e=[...new Set(e)],e},cell:t=>{let e=tt.grid[t.x][t.y];return e?[e]:[]},adjacent:t=>{let e=[tt.grid[t.x][t.y]];for(let i=-1;i<=1;i+=2)try{let s=tt.grid[t.x+i][t.y];s&&e.push(s)}catch{}for(let i=-1;i<=1;i+=2)try{let s=tt.grid[t.x][t.y+i];s&&e.push(s)}catch{}return e},surrounding:t=>{let e=[];for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++)try{let r=tt.grid[t.x+i][t.y+s];r&&e.push(r)}catch{}return e}}),dt=Object.freeze({blank:t=>{console.log("Power does nothing")},dig:t=>{t.forEach((t=>{t.machine.run("crumble")}))},destroy:t=>{t.forEach((t=>{t.machine.run("snipe")}))},increase:t=>{t.forEach((t=>{t.machine.run("changeValue",[!0])}))},decrease:t=>{t.forEach((t=>{t.machine.run("changeValue",[!1])}))}});class ut{constructor(){this.name="[ADD NAME]",this.description="A power",this.range=lt.board,this.effect=dt.blank,this.useTurn=!0,this.pointsRequired=100,this.filter=t=>!0,this.effectDelay=300,this.multiplier=.5}highlightTargets=()=>tt.coins.map((t=>{this.filter(t)||(t.opacity=.3)}));activate=t=>{tt.coins.forEach((t=>t.opacity=1)),this.effect(this.range(t))}}class ft extends ut{constructor(){super(),this.name="Dig",this.description="Remove one layer of dirt from all buried coins.",this.range=lt.surrounding,this.effect=dt.dig,this.filter=t=>t.dirtLayer>0}}class gt extends ut{constructor(){super(),this.name="Snipe",this.description="Destroys coin with tactical precision.",this.range=lt.cell,this.effect=dt.destroy,this.effectDelay=0,this.pointsRequired=60}}class xt extends ut{constructor(){super(),this.name="Increase",this.description="Increases value of coins in range by one (7s become buried coins and their values are randomised).",this.range=lt.cross,this.effect=dt.increase,this.filter=t=>0===t.dirtLayer,this.pointsRequired=80}}class yt extends p{constructor(){super({x:147,y:tt.boardDims.height+10,zIndex:50,powerSlots:[],render:()=>{const t=this.context;t.lineWidth=4,t.strokeStyle="#567",t.strokeRect(0,0,200,70),this.powerSlots.forEach(((e,i)=>{t.beginPath(),t.arc(60*i+15+25,35,25,0,2*Math.PI),t.closePath(),t.stroke()}))}});let t=[ft,gt,xt];for(let e=0;e<3;e++){const i=new pt(new(0,t[e]),{x:60*e+15+25,y:35});this.addChild(i),this.powerSlots.push(i)}}}class pt extends p{constructor(e=null,i={}){let s={x:0,y:0},r={x:i.x,y:i.y},n=new q("LOCKED",{LOCKED:{drag:()=>console.log(this.meter,this.parent)},UNLOCKED:{start:()=>{tt.coins.map((t=>t.opacity=1))},drag:()=>n.setStateAndRun("SELECT")},SELECT:{start:()=>{s.x=S().x,s.y=S().y,this.parent.children.sort(((t,e)=>t===this?1:-1)),this.power.highlightTargets(),tt.gameMachine.run("pendPower")},release:()=>{this.x=r.x,this.y=r.y,s={x:0,y:0},tt.gameMachine.run("cancel"),n.setStateAndRun("UNLOCKED")},update:()=>{let e={};e.x=S().x-s.x+r.x,e.y=S().y-s.y+r.y,this.x=t(r.x,e.x,.3),this.y=t(r.y,e.y,.3),Math.sqrt((this.x-r.x)**2+(this.y-r.y)**2)>15&&n.setState("DRAG")}},DRAG:{release:()=>{n.setStateAndRun("SNAPBACK"),s={x:0,y:0},this.valid?(tt.gameMachine.run("activate",[this.power]),e.multiplier+=.1):tt.gameMachine.run("cancel"),this.valid=!1},update:()=>{this.x=S().x-s.x+r.x,this.y=S().y-s.y+r.y,this.valid=null!=function(){const t=tt.cursorCellPos.value;return t.x>=0&&t.x<J.slots.x&&t.y>=0&&t.y<J.slots.y?t:null}(),this.valid?tt.powerCursor.targets=this.power.range(tt.cursorCellPos.value):tt.powerCursor.targets=[]}},SNAPBACK:{start:()=>{tt.powerCursor.targets=[],this.valid&&(this.x=r.x,this.y=r.y,this.prevScore=tt.score.value,this.meter=0,this.isEnabled=!1,n.setStateAndRun("LOCKED")),this.lerpPos=.01},update:()=>{this.x=t(this.x,r.x,this.lerpPos),this.y=t(this.y,r.y,this.lerpPos),Math.abs(this.x-r.x)<1&&Math.abs(this.y-r.y)<1&&(this.x=r.x,this.y=r.y,n.setStateAndRun("UNLOCKED")),this.lerpPos=t(this.lerpPos,1,.2)}}});super(Object.assign({},{power:e,machine:n,meter:1,prevScore:0,stock:0,radius:22,anchor:{x:.5,y:.5},valid:!1,render:()=>{const t=this.context;t.lineWidth=2.5,t.strokeStyle=this.valid?"#FFF":"#CCC",t.fillStyle="#333",t.beginPath(),t.arc(22,20,25,0,2*Math.PI),t.closePath(),t.fill(),t.beginPath(),t.arc(22,20,25,2*Math.PI*-.25,2*Math.PI*(this.meter-.25)),1!==this.meter&&t.lineTo(22,20),t.closePath(),t.fillStyle=this.valid?"#888":"#555",t.fill(),1===this.meter&&t.stroke()},collidesWithPointer:t=>{let e=tt.getWorldPos(this),i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i**2+s**2)<this.radius},onDown:()=>{"INPUT"==tt.gameMachine.state&&this.machine.run("drag")},onOver:()=>{},onOut:()=>{},update:()=>{this.advance(),this.machine.run("update"),E["left"]||this.machine.run("release")}},i)),tt.addDebugText(this.power,"multiplier",e.name,5),this.addChild(new v({color:"white",text:this.power.name,font:"bold 10px Arial",textAlign:"center",width:40,x:-20,y:-5})),tt.score.listen((()=>{this.meter=J.freePowers?1:Math.min(1,(tt.score-this.prevScore)/(e.pointsRequired*e.multiplier)),1!==this.meter||this.isEnabled||(this.isEnabled=!0,tt.particles.addEffect("eyeCatch",{pos:{x:r.x+this.parent.x,y:r.y+this.parent.y}}),n.setStateAndRun("UNLOCKED"))})),k(this)}}class mt extends p{constructor(){super({targets:[],zIndex:20,render:()=>{if("HIDDEN"===this.machine.state)return;let t=this.context,e=2*J.coinRadius+J.coinBuffer,i=J.coinBuffer/2;this.targets.forEach((s=>{s&&(t.strokeStyle="#FFF",t.lineWidth=2,t.strokeRect(s.x-i,s.y-i,e,e))}))}}),this.machine=new q("VISIBLE",{HIDDEN:{start:()=>{},show:()=>{}},VISIBLE:{start:()=>{},hide:()=>{}}})}}class wt extends y{constructor(){super({x:-30-J.coinBuffer,y:J.coinBuffer/2,render:()=>{let t=this.context;for(let e=0;e<J.turnsInRound;e++)t.fillStyle=t.strokeStyle="#678",tt.remainingTurns>e&&t.fillRect(0,30*e,20,20),t.strokeRect(0,30*e,20,20)}})}}class _t extends y{constructor(){super({x:tt.boardDims.width+J.coinBuffer+24,y:J.coinBuffer/2+24,radius:24,colour:"#678",machine:new q("IDLE",{IDLE:{},PULSING:{},HOVERED:{},RESTARTING:{}}),collidesWithPointer:t=>{let e=tt.getWorldPos(this),i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i**2+s**2)<this.radius},onDown:()=>{tt.gameMachine.run("restart")},onOver:()=>{this.colour="white"},onOut:()=>{this.colour="#678"},render:()=>{let t=this.context;t.beginPath(),t.fillStyle=t.strokeStyle=this.colour,t.arc(0,0,24,0,2*Math.PI),t.translate(-12.8,-12.8),t.lineWidth=2,t.stroke(),t.scale(.05,.05),t.lineWidth=16,[new Path2D("M444.84 83.16c-46.804-51.108-114.077-83.16-188.84-83.16-141.385 0-256 114.615-256 256h48c0-114.875 93.125-208 208-208 61.51 0 116.771 26.709 154.848 69.153l-74.848 74.847h176v-176l-67.16 67.16z"),new Path2D("M464 256c0 114.875-93.125 208-208 208-61.51 0-116.771-26.709-154.847-69.153l74.847-74.847h-176v176l67.16-67.16c46.804 51.108 114.077 83.16 188.84 83.16 141.385 0 256-114.615 256-256h-48z")].forEach((e=>{t.fill(e),t.stroke(e)})),t.closePath()}}),k(this)}}const vt={color:"#ABC",height:6,width:6,count:18,ttl:60,rotation:2*Math.PI*Math.random(),gravity:0,decel:.97,shrink:.3,vector:{x:0,y:0},border:0,anchor:{x:.5,y:.5},randomise:function(t){Rt(this,t)},update:function(){this.advance(),this.dx*=this.decel,this.dy=0==this.gravity?this.dy*this.decel:this.dy+this.gravity,this.height-=this.shrink,this.width-=this.shrink,this.height<=0?this.ttl=0:this.ttl--}},Pt={popping:{...vt,height:14,width:14,gravity:.5,shrink:.4,ttl:100},breaking:{...vt,count:15,decel:.98,ttl:100,height:8,width:8,shrink:.12,randomise:function(t){Rt(this,t,!0),this.dx=this.dy=0}},crumbling:{...vt,count:15,decel:.98,ttl:100,shrink:.2,randomise:function(t){Rt(this,t,!0),this.dx=this.dy=0}},restarting:{...vt,count:12,width:9,height:9,shrink:.3},eyeCatch:{...vt,count:40,width:6,height:6,shrink:.08,color:"#FFF",decel:.995,ttl:400,rotation:2*Math.PI*45,randomise:function(t){Rt(this,t,!1,J.coinRadius-3),this.dx*=.2,this.dy*=.2}}};function Rt(t,e,i=!1,s=J.coinRadius){let r=360*(e+(i?.08*Math.random()-.04:1))*Math.PI/180;t.vector.x=Math.sin(r),t.vector.y=Math.cos(r),t.x=t.pos.x+t.vector.x*s+tt.camera.x,t.y=t.pos.y+t.vector.y*s+tt.camera.y,t.dx=t.vector.x*Math.random()*2,t.dy=t.vector.y*Math.random()*2,t.rotation=Math.random()}let{canvas:Et}=function(t,{contextless:e=!1}={}){if(r=document.getElementById(t)||t||document.querySelector("canvas"),e&&(r=r||new Proxy({},c)),!r)throw Error("You must provide a canvas element for the game");return n=r.getContext("2d")||new Proxy({},c),n.imageSmoothingEnabled=!1,a("init"),{canvas:r,context:n}}(),bt=new class extends p{constructor(){super(),this.pool=function(){return new $(...arguments)}({create:m})}addEffect(t,e){let i={...Pt[t]??vt,...e};for(let t=0;t<i.count;t++)i.randomise(t/i.count),this.pool.get(i)}update(){this.pool.update()}render(){this.pool.render()}};(function({radius:t=5,canvas:e=l()}={}){let i=P.get(e);if(!i){let s=window.getComputedStyle(e);i={x:0,y:0,radius:t,touches:{length:0},canvas:e,_cf:[],_lf:[],_o:[],_oo:null,_s:s},P.set(e,i)}e.addEventListener("mousedown",I),e.addEventListener("touchstart",I),e.addEventListener("mouseup",D),e.addEventListener("touchend",D),e.addEventListener("touchcancel",D),e.addEventListener("blur",C),e.addEventListener("mousemove",M),e.addEventListener("touchmove",M),i._t||(i._t=!0,h("tick",(()=>{i._lf.length=0,i._cf.map((t=>{i._lf.push(t)})),i._cf.length=0})))})(),function(){let t;for(t=0;t<26;t++)j["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)j["Digit"+t]=j["Numpad"+t]=""+t;window.addEventListener("keydown",U),window.addEventListener("keyup",X),window.addEventListener("blur",Y)}();class St{constructor(){tt={gameMachine:null,camera:null,bg:null,grid:Array.from({length:J.slots.x},(t=>Array.from({length:J.slots.y},(t=>null)))),boardDims:{height:J.slots.y*(2*J.coinRadius+J.coinBuffer),width:J.slots.x*(2*J.coinRadius+J.coinBuffer)},dropZone:null,maxCoinValue:Math.max(J.slots.x,J.slots.y),coinWeights:null,remainingTurns:J.initialTurns,coins:[],score:new Z(0),roundScore:new Z(0),cursorCellPos:new Z({x:0,y:0}),combo:1,gameOver:!1,addDebugText:(t,e,i,s=0,r=!1)=>{Q.push({name:i||"",object:t,value:e,order:s,pc:r}),Q.sort(((t,e)=>(t.order>e.order)-(t.order<e.order)))},getDebugText:(t="\n")=>{let e="";return Q.forEach(((i,s)=>{let r=i.object[i.value];isNaN(r)||(r=parseFloat(r).toPrecision(2)),i.pc&&(r=Math.round(1e4*r)/100),e=e.concat(i.name,i.name&&": ",r,i.pc?"%":""),s!=Q.length-1&&(e=e.concat(t))})),e},resetDebugText:()=>Q=[],isInGrid:(t,e=!1)=>!(t.x<0||t.x>=J.slots.x||!e&&t.y<0||t.y>=J.slots.y),getWorldPos:t=>{let e={x:0,y:0};for(;t;)e.x+=t.x,e.y+=t.y,t=t.parent;return e}},tt.coinWeights=Object.fromEntries(Array.from({length:tt.maxCoinValue+(J.dirtCoins?1:0)},((t,e)=>[e+1,1]))),tt.resetDebugText(),tt.addDebugText(tt,"combo","Combo",2),tt.particles=bt,tt.addDebugText(bt.pool,"size","Particle Count",4),this.dropZone=new st,this.changes=null,this.gridBg=tt.bg=new ht,this.powerCursor=tt.powerCursor=new mt,this.machine=tt.gameMachine=new q("NEXTROUND",{INPUT:{start:()=>{if(this.roundScore.timeout=setTimeout((()=>this.roundScore.fadeout()),1400),tt.combo=1,tt.gameOver)e.setStateAndRun("GAMEOVER");else if(s.machine.run("unlock"),!s.coin){let t=function(t){const{weightCoins:e,slots:i}=J,{coinWeights:s,maxCoinValue:r}=tt;if(!e)return K(0,i.x-1);let n=0,o=K(0,Object.values(s).reduce(((t,e)=>t+e),0)),h=null;for(let t=1;t<=Object.keys(s).length;t++)if(n+=s[t],o<=n){h=t;break}Object.keys(s).forEach((t=>s[t]+=Object.keys(s).length)),s[h]=1;let a=h>r;return new et(t,{value:a?K(1,r):h,dirtLayer:a?K(1,2):0})}(s.x);s.coin=t,t.machine.run("start",[s]),this.camera.addChild(t)}},prime:()=>{s.machine.run("prime"),this.camera.children=this.camera.children.filter((t=>t.ttl>0))},drop:()=>{s.machine.run("drop")&&(tt.remainingTurns--,e.setStateAndRun("DROPPING"))},pendPower:()=>{s.machine.run("lock"),e.setStateAndRun("POWERPENDING")},power:t=>{e.setStateAndRun("POWER","start",[t])},restart:()=>this.restart()},DROPPING:{start:()=>{tt.coins.sort(((t,e)=>(t.gridPos.y<e.gridPos.y)-(t.gridPos.y>e.gridPos.y))),tt.coins.forEach((t=>{t.machine.run("drop")})),t=tt.coins.filter((t=>!["IDLE","DROPZONE"].includes(t.machine.state))).length},update:()=>{tt.gameOver?e.setStateAndRun("GAMEOVER"):0===tt.coins.filter((t=>"IDLE"!==t.machine.state)).length&&e.setStateAndRun("POPPING")}},POPPING:{start:()=>{tt.coins.forEach((t=>{t.machine.run("pop")})),t=tt.coins.filter((t=>"IDLE"!==t.machine.state)).length,tt.roundScore.listen((()=>{0!=tt.roundScore.value&&(clearTimeout(this.roundScore.timeout),this.roundScore.fadeout(!1),this.roundScore.opacity=1,this.roundScore.text=`+ ${tt.roundScore.value}`)}))},update:()=>{tt.coins=tt.coins.filter((t=>t.isAlive())),0===tt.coins.filter((t=>!["IDLE","DROPZONE"].includes(t.machine.state))).length&&(t>0?(this.machine.setStateAndRun("DROPPING"),tt.combo++):e.setStateAndRun("NEXTROUND"))}},POWERPENDING:{start:()=>{},cancel:()=>{e.setStateAndRun("INPUT")},activate:t=>{e.setStateAndRun("POWER","start",[t])}},POWER:{start:t=>{if(!t)return e.setStateAndRun("INPUT");t.useTurn&&tt.remainingTurns--,t.activate(tt.cursorCellPos.value),setTimeout((()=>e.setStateAndRun("POPPING")),t.effectDelay)}},NEXTROUND:{start:()=>{if(tt.roundScore.value=0,tt.roundScore.clearListeners(),tt.remainingTurns>0)e.setStateAndRun("INPUT");else{let t="rise"==J.roundMode?"RISING":"DROPPING";tt.remainingTurns=J.turnsInRound,tt.coins.forEach((e=>{e.machine.setStateAndRun(t)}));let e=null;for(let i=0;i<J.slots.x;i++){let s;do{s=K(1,tt.maxCoinValue)}while(s===e);e=s;let r=new et(i,{gridPos:{x:i,y:"rise"==J.roundMode?J.slots.y:-1},y:"rise"==J.roundMode?tt.boardDims.height:2*-J.coinRadius-J.coinBuffer,dirtLayer:2,value:s});tt.coins.push(r),r.machine.setStateAndRun(t),this.camera.addChild(r)}this.zSort()}},update:()=>{let t=0===tt.coins.filter((t=>"IDLE"!==t.machine.state)).length;tt.gameOver?e.setStateAndRun("GAMEOVER"):t&&e.setStateAndRun("POPPING")}},GAMEOVER:{start:()=>{this.roundScore.timeout=setTimeout((()=>{this.roundScore.fadeout(),console.log("timing out",tt.score.value)}),1400),s.machine.run("lock")},restart:()=>this.restart()}});let{changes:t,machine:e,camera:i,dropZone:s}=this;this.camera=tt.camera=y({x:350-(J.coinRadius+J.coinBuffer)*(J.slots.x-1)+J.coinBuffer/2,y:2*J.coinRadius+2*J.coinBuffer}),tt.debugInfo=this.debugText=v({color:"white",text:"hello",font:"bold 12px Arial",opacity:0,update:()=>{this.debugText.text=tt.getDebugText("\n\n")}}),this.score=v({x:tt.boardDims.width-J.coinBuffer,y:tt.boardDims.height+10,color:"white",text:"hello",anchor:{x:1,y:0},textAlign:"right",font:"bold 28px Arial",update:()=>{this.score.text=`${tt.score}`}}),this.roundScore=v({x:tt.boardDims.width-J.coinBuffer,y:tt.boardDims.height+42,color:"#999",text:"",anchor:{x:1,y:0},textAlign:"right",font:"bold 16px Arial",fading:!1,timeout:null,fadeout:(t=!0)=>this.fading=t,update:()=>{this.fading&&(this.roundScore.opacity>0?this.roundScore.opacity-=.02:this.fading=!1)}}),tt.addDebugText(e,"state",null,3),this.camera.addChild(s,this.gridBg,new it,this.debugText,this.score,this.roundScore,new wt,new _t,this.powerCursor,new yt),e.run("start")}update(){this.camera.update(),this.machine.run("update"),tt.cursorCellPos.value=function(){let t=function(){const t=(({x:t,y:e})=>({x:t,y:e}))(S());return Object.keys(t).forEach((function(e,i){t[e]-=tt.camera[e]-J.coinBuffer/2})),t}();return Object.keys(t).forEach((function(e,i){t[e]=Math.floor(t[e]/(2*J.coinRadius+J.coinBuffer))})),t}()}restart(){let t=e=>{if(e!=J.slots.x){for(let t=-1;t<J.slots.y;t++)tt.grid[e][t]&&tt.grid[e][t].machine.run("restart");setTimeout((()=>t(e+1)),30)}else setTimeout((()=>At.game=new St),30)};t(0)}zSort(){this.camera.children.sort(((t,e)=>(t.zIndex>e.zIndex)-(t.zIndex<e.zIndex)))}}let At={game:new St};(function({fps:t=60,clearCanvas:e=!0,update:s=i,render:r,context:n=d(),blur:o=!1}={}){if(!r)throw Error("You must provide a render() function");let c,l,u,f,g,x=0,y=1e3/t,p=1/t,m=e?N:i,w=!0;function _(){if(l=requestAnimationFrame(_),w&&(u=performance.now(),f=u-c,c=u,!(f>1e3))){for(x+=f;x>=y;)a("tick"),g.update(p),x-=y;m(g.context),g.render()}}return o||(window.addEventListener("focus",(()=>{w=!0})),window.addEventListener("blur",(()=>{w=!1}))),h("init",(()=>{g.context??=d()})),g={update:s,render:r,isStopped:!0,context:n,start(){this.isStopped&&(c=performance.now(),this.isStopped=!1,requestAnimationFrame(_))},stop(){this.isStopped=!0,cancelAnimationFrame(l)},_frame:_,set _last(t){c=t}},g})({update:()=>{null!=At.game&&At.game.update(),bt.update()},render:()=>{At.game.camera.render(),bt.render()}}).start()})();